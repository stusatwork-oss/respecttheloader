name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        pip install -r requirements.txt

    - name: Run black (code formatting check)
      run: black --check .
      continue-on-error: true

    - name: Run isort (import sorting check)
      run: isort --check-only .
      continue-on-error: true

    - name: Run flake8 (linting)
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      continue-on-error: true

    - name: Run mypy (type checking)
      run: mypy *.py tools/*.py
      continue-on-error: true

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.7', '3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        pip install -r requirements.txt

    - name: Run tests
      run: |
        # Currently no tests, but framework is ready
        echo "Test framework ready - add tests in future"
        # pytest --cov=. --cov-report=xml --cov-report=html
      continue-on-error: true

    - name: Upload coverage reports
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
      uses: codecov/codecov-action@v3
      continue-on-error: true

  validate-manifest:
    name: Validate Manifest
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Validate shareware.yml
      run: |
        python -c "import yaml; yaml.safe_load(open('shareware.yml'))"
        echo "✅ Manifest is valid YAML"

    - name: Run AI bot compliance check
      run: |
        python tools/ai_bot_03.py
        echo "✅ AI bot respects the sacred law"

  check-protected-files:
    name: Check Protected Files
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Check for modifications to protected files
      run: |
        # Get list of changed files
        changed_files=$(git diff --name-only origin/main...HEAD)

        # Files that should not be modified without approval
        protected_patterns="THE_BOOK_OF_STULATIONS.md|archive/.*/.*"

        # Check if any protected files were changed
        if echo "$changed_files" | grep -E "$protected_patterns"; then
          echo "⚠️  Warning: Protected files were modified!"
          echo "Please ensure maintainer approval for changes to:"
          echo "$changed_files" | grep -E "$protected_patterns"
          echo ""
          echo "See THE_BOOK_OF_STULATIONS.md for the Sacred Law."
          # Don't fail the build, just warn
          exit 0
        else
          echo "✅ No protected files modified"
        fi
